<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Storm Cost Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
        .spinner { border: 4px solid rgba(0, 0, 0, .1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-tab.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .modal-content-pane { display: none; }
        .modal-content-pane.active { display: block; }
        
        /* Fix dashboard layout issues */
        .dashboard-container {
            min-height: calc(100vh - 120px);
            position: relative;
        }
        .chart-container {
            height: 300px;
            position: relative;
            overflow: hidden;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Prevent layout shifts */
        .fixed-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Improve input handling */
        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Prevent text input from causing layout shifts */
        .input-container {
            position: relative;
            margin-bottom: 1rem;
        }
        
        /* Print-specific styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
            .no-print { display: none; }
            table { font-size: 10px; border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ccc; padding: 4px; }
            h1, h2, h3 { text-align: center; margin-bottom: 1rem; color: #000; }
            .modal { display: block !important; position: relative !important; transform: none !important; width: 100% !important; max-width: 100% !important; box-shadow: none; border: none; }
            .modal-backdrop { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 sidebar no-print">
            <a href="#" class="text-xl font-bold px-4 flex items-center space-x-2">
                <i class="fas fa-snowflake text-blue-500"></i>
                <span>Advanced Storm Tracker</span>
            </a>
            <nav>
                <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-500 hover:text-white"><i class="fas fa-chart-pie mr-2"></i>Dashboard</a>
                <a href="#storm-list" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-500 hover:text-white"><i class="fas fa-list-ul mr-2"></i>Data List</a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden main-content">
            <header class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 border-b dark:border-gray-700 no-print fixed-header">
                <button id="menu-button" class="text-gray-500 dark:text-gray-400 focus:outline-none md:hidden"><i class="fas fa-bars text-2xl"></i></button>
                <h1 id="page-title" class="text-2xl font-semibold ml-4">Dashboard</h1>
                <button id="add-storm-btn-header" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-plus mr-2"></i>Log New Storm</button>
            </header>
            <main id="app" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 dark:bg-gray-900 p-6 dashboard-container" style="margin-top: 80px;"></main>
        </div>
    </div>

    <!-- Data Entry Modal -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="storm-modal" class="modal w-11/12 md:max-w-4xl mx-auto rounded-lg shadow-lg bg-white dark:bg-gray-800">
        <div class="p-6">
            <div class="flex justify-between items-center pb-3 mb-4 border-b dark:border-gray-700">
                <p id="modal-title" class="text-2xl font-bold">Log New Storm Event</p>
                <button id="close-modal-btn" class="cursor-pointer z-50"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-4" id="modal-tabs">
                    <button data-tab="info" class="modal-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-info-circle mr-2"></i>Info</button>
                    <button data-tab="labor" class="modal-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-users-cog mr-2"></i>Labor</button>
                    <button data-tab="equipment" class="modal-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-truck-plow mr-2"></i>Equipment</button>
                    <button data-tab="product" class="modal-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-cubes mr-2"></i>Product</button>
                    <button data-tab="contractor" class="modal-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-hard-hat mr-2"></i>Contractor</button>
                </nav>
            </div>
            <form id="storm-form" class="mt-4 max-h-[60vh] overflow-y-auto pr-2">
                <input type="hidden" id="storm-id">
                <div id="pane-info" class="modal-content-pane active"></div>
                <div id="pane-labor" class="modal-content-pane"></div>
                <div id="pane-equipment" class="modal-content-pane"></div>
                <div id="pane-product" class="modal-content-pane"></div>
                <div id="pane-contractor" class="modal-content-pane"></div>
                 <div class="flex justify-end pt-4 mt-4 border-t dark:border-gray-700">
                    <button type="button" id="cancel-btn" class="px-4 bg-gray-200 p-3 rounded-lg hover:bg-gray-300 mr-2">Cancel</button>
                    <button type="submit" id="save-storm-btn" class="px-4 bg-blue-500 p-3 rounded-lg text-white hover:bg-blue-600 flex items-center"><div id="save-spinner" class="spinner mr-2" style="display:none;"></div>Save Storm</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Details/Print Modal -->
    <div id="details-modal" class="modal w-11/12 md:max-w-4xl mx-auto rounded-lg shadow-lg bg-white dark:bg-gray-800">
         <div class="p-6">
            <div class="flex justify-between items-center pb-3 mb-4 border-b dark:border-gray-700 no-print">
                <p id="details-modal-title" class="text-2xl font-bold">Storm Details</p>
                <button id="close-details-modal-btn" class="cursor-pointer z-50"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="print-area" class="max-h-[75vh] overflow-y-auto">
                <!-- Detailed storm report will be injected here -->
            </div>
            <div class="flex justify-end pt-4 mt-4 border-t dark:border-gray-700 no-print">
                <button type="button" id="print-details-btn" class="px-4 bg-blue-500 p-3 rounded-lg text-white hover:bg-blue-600"><i class="fas fa-print mr-2"></i>Print / Save as PDF</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Chart.js Global Config ---
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.color = '#6b7280';
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;

    // --- GEMINI API SETUP ---
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
    async function callGemini(prompt) {
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed: ${response.status}`);
            const result = await response.json();
            return result.candidates[0].content.parts[0].text.replace(/["'.]/g, '');
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            return `Error: Could not connect to AI.`;
        }
    }

    // --- DATA & CONFIG ---
    let storms = [{id:1,info:{stormNo:1,stormName:"Hushfall",preparedBy:"Admin",dayOfWeek:"Monday",minTemp:25,stormStarted:"2025-07-28T08:00",stormEnded:"2025-07-28T18:00",roadsClear:"2025-07-28T20:00",precipitation:"Dry Snow",snow:8,drifts:12},labor:[{name:"Henry",regHrs:22,regRate:18,otHrs:2,otRate:25}],equipment:[{name:"3/4ton P/U plow/sander",hours:30,rate:25}],product:[{name:"Salt",tons:20,rate:200}],contractor:[{name:"Carrigan",cost:40000}],costs:{labor:446,equipment:750,product:4000,contractor:40000,total:45196}}];
    let activeStormId = null;
    const equipmentList = ['3/4ton P/U plow/sander', '1 ton truck with plow, wing, and sander', '3-5 ton truck with plow, wing & sander', '10 Wheel truck with plow wing and sander', 'Grader with plow and wing', 'Loader', 'Backhoe w pusher for muni parking lots', 'Other'];
    const productList = ['Salt', 'Liquid 1', 'Liquid 2', 'Sand', 'Treated Salt', 'Other'];

    // --- DOM ELEMENTS ---
    const app = document.getElementById('app');
    const pageTitle = document.getElementById('page-title');
    const navLinks = document.querySelectorAll('.nav-link');
    const modal = document.getElementById('storm-modal');
    const detailsModal = document.getElementById('details-modal');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const stormForm = document.getElementById('storm-form');

    // --- DYNAMIC FORM TEMPLATES ---
    const createRow = (content) => `<div class="grid grid-cols-12 gap-2 items-center mb-2 dynamic-row">${content}</div>`;
    const deleteBtn = `<div class="col-span-1"><button type="button" class="delete-row-btn text-red-500 hover:text-red-700 pt-6"><i class="fas fa-trash"></i></button></div>`;
    
    const infoTemplate = () => `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Storm No.</label>
                <input type="number" id="info-stormNo" class="form-input" placeholder="Enter storm number">
            </div>
            <div class="input-container md:col-span-2">
                <label class="block text-sm font-medium mb-1">Storm Name</label>
                <div class="flex items-center">
                    <input type="text" id="info-stormName" class="form-input" placeholder="Enter storm name" required>
                    <button type="button" id="suggest-name-btn" class="ml-2 px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 flex-shrink-0" title="Suggest a name using AI">✨</button>
                </div>
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Prepared By</label>
                <input type="text" id="info-preparedBy" class="form-input" placeholder="Enter preparer name">
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Day of Week</label>
                <input type="text" id="info-dayOfWeek" class="form-input" placeholder="e.g., Monday">
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Min Temp (°F)</label>
                <input type="number" id="info-minTemp" class="form-input" placeholder="Enter temperature">
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Storm Started</label>
                <input type="datetime-local" id="info-stormStarted" class="form-input">
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Storm Ended</label>
                <input type="datetime-local" id="info-stormEnded" class="form-input">
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Roads Clear</label>
                <input type="datetime-local" id="info-roadsClear" class="form-input">
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Precipitation</label>
                <select id="info-precipitation" class="form-input">
                    <option value="">Select precipitation type</option>
                    <option value="Dry Snow">Dry Snow</option>
                    <option value="Wet Snow">Wet Snow</option>
                    <option value="Sleet">Sleet</option>
                    <option value="Freezing Rain">Freezing Rain</option>
                </select>
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Snow (in)</label>
                <input type="number" step="0.1" id="info-snow" class="form-input" placeholder="Enter snowfall">
            </div>
            <div class="input-container">
                <label class="block text-sm font-medium mb-1">Drifts (in)</label>
                <input type="number" step="0.1" id="info-drifts" class="form-input" placeholder="Enter drift height">
            </div>
        </div>
    `;
    
    const laborTemplate = () => createRow(`
        <div class="col-span-3">
            <label class="block text-sm font-medium mb-1">Name</label>
            <input type="text" class="data-name form-input" placeholder="Enter worker name">
        </div>
        <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">Reg Hrs</label>
            <input type="number" step="0.1" class="data-regHrs form-input" placeholder="Hours">
        </div>
        <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">Reg Rate</label>
            <input type="number" step="0.01" class="data-regRate form-input" placeholder="Rate">
        </div>
        <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">OT Hrs</label>
            <input type="number" step="0.1" class="data-otHrs form-input" placeholder="OT hours">
        </div>
        <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">OT Rate</label>
            <input type="number" step="0.01" class="data-otRate form-input" placeholder="OT rate">
        </div>
        ${deleteBtn}
    `);
    
    const equipmentTemplate = () => createRow(`
        <div class="col-span-5">
            <label class="block text-sm font-medium mb-1">Equipment</label>
            <select class="data-name form-input">
                <option value="">Select equipment</option>
                ${equipmentList.map(e => `<option value="${e}">${e}</option>`).join('')}
            </select>
        </div>
        <div class="col-span-3">
            <label class="block text-sm font-medium mb-1">Hours</label>
            <input type="number" step="0.1" class="data-hours form-input" placeholder="Hours used">
        </div>
        <div class="col-span-3">
            <label class="block text-sm font-medium mb-1">Rate</label>
            <input type="number" step="0.01" class="data-rate form-input" placeholder="Rate per hour">
        </div>
        ${deleteBtn}
    `);
    
    const productTemplate = () => createRow(`
        <div class="col-span-5">
            <label class="block text-sm font-medium mb-1">Product</label>
            <select class="data-name form-input">
                <option value="">Select product</option>
                ${productList.map(p => `<option value="${p}">${p}</option>`).join('')}
            </select>
        </div>
        <div class="col-span-3">
            <label class="block text-sm font-medium mb-1">Tons Used</label>
            <input type="number" step="0.1" class="data-tons form-input" placeholder="Tons">
        </div>
        <div class="col-span-3">
            <label class="block text-sm font-medium mb-1">$ per Ton</label>
            <input type="number" step="0.01" class="data-rate form-input" placeholder="Price per ton">
        </div>
        ${deleteBtn}
    `);
    
    const contractorTemplate = () => createRow(`
        <div class="col-span-6">
            <label class="block text-sm font-medium mb-1">Product/Service</label>
            <input type="text" class="data-name form-input" placeholder="Enter service description">
        </div>
        <div class="col-span-5">
            <label class="block text-sm font-medium mb-1">Total Cost</label>
            <input type="number" step="0.01" class="data-cost form-input" placeholder="Total cost">
        </div>
        ${deleteBtn}
    `);
    
    const paneTemplates = { info: infoTemplate, labor: laborTemplate, equipment: equipmentTemplate, product: productTemplate, contractor: contractorTemplate };
    
    // --- DYNAMIC FORM LOGIC ---
    function renderDynamicPane(paneId, data) {
        const pane = document.getElementById(`pane-${paneId}`);
        if(paneId === 'info') {
             pane.innerHTML = paneTemplates.info();
             return;
        }
        let content = `<h3 class="text-lg font-semibold mb-4 capitalize">${paneId} Costs</h3>`;
        if (data && data.length > 0) {
            content += data.map(item => {
                const row = paneTemplates[paneId]();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = row;
                Object.keys(item).forEach(key => {
                    const input = tempDiv.querySelector(`.data-${key}`);
                    if (input) input.value = item[key];
                });
                return tempDiv.innerHTML;
            }).join('');
        } else {
            content += paneTemplates[paneId]();
        }
        content += `<button type="button" class="add-row-btn mt-4 text-blue-600 hover:text-blue-800 font-medium" data-pane="${paneId}"><i class="fas fa-plus mr-2"></i>Add Row</button>`;
        pane.innerHTML = content;
    }

    // --- TEMPLATES ---
    const dashboardTemplate = () => {
        const totalStorms = storms.length;
        const totalCost = storms.reduce((acc, s) => acc + s.costs.total, 0);
        return `
            <div class="stats-grid">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="font-semibold text-gray-500 mb-2">Total Storms Logged</h3>
                    <p class="text-4xl font-bold text-gray-900 dark:text-white">${totalStorms}</p>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="font-semibold text-gray-500 mb-2">Total Seasonal Cost</h3>
                    <p class="text-4xl font-bold text-gray-900 dark:text-white">$${totalCost.toLocaleString()}</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-xl font-semibold mb-4">Cost per Storm</h3>
                    <div class="chart-container">
                        <canvas id="cost-per-storm-chart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-xl font-semibold mb-4">Total Cost Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="cost-breakdown-chart"></canvas>
                    </div>
                </div>
            </div>
        `;
    };
    
    const stormListTemplate = () => `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead><tr class="border-b dark:border-gray-700">
                        <th class="p-3 font-semibold">Storm Name</th><th class="p-3 font-semibold">Date</th><th class="p-3 font-semibold">Snow (in)</th><th class="p-3 font-semibold">Total Cost</th><th class="p-3 font-semibold no-print">Actions</th>
                    </tr></thead>
                    <tbody id="storm-table-body">${renderStorms(storms)}</tbody>
                </table>
            </div>
        </div>
    `;

    // --- RENDER & CHART FUNCTIONS ---
    function renderStorms(stormData) {
        if (stormData.length === 0) return '<tr><td colspan="5" class="text-center p-8 text-gray-500">No storms logged yet.</td></tr>';
        return stormData.map(s => `
            <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="p-3 font-semibold">${s.info.stormName}</td>
                <td class="p-3">${new Date(s.info.stormStarted).toLocaleDateString()}</td>
                <td class="p-3">${s.info.snow}"</td>
                <td class="p-3 font-semibold">$${s.costs.total.toLocaleString()}</td>
                <td class="p-3 no-print">
                    <button class="details-btn text-green-500 hover:text-green-700 mr-2" data-id="${s.id}" title="View Details"><i class="fas fa-file-alt"></i></button>
                    <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${s.id}" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="delete-btn text-red-500 hover:text-red-700" data-id="${s.id}" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }
    
    function renderDashboardCharts() {
        const costChart = document.getElementById('cost-per-storm-chart');
        const breakdownChart = document.getElementById('cost-breakdown-chart');
        
        if (!costChart || !breakdownChart) return;
        
        // Destroy existing charts to prevent memory leaks
        if (window.costChart) window.costChart.destroy();
        if (window.breakdownChart) window.breakdownChart.destroy();
        
        const costBreakdown = storms.reduce((acc, s) => {
            acc.labor += s.costs.labor; 
            acc.equipment += s.costs.equipment;
            acc.product += s.costs.product; 
            acc.contractor += s.costs.contractor;
            return acc;
        }, { labor: 0, equipment: 0, product: 0, contractor: 0 });

        // Create cost per storm chart
        window.costChart = new Chart(costChart.getContext('2d'), {
            type: 'bar',
            data: { 
                labels: storms.map(s => s.info.stormName), 
                datasets: [{ 
                    label: 'Total Cost', 
                    data: storms.map(s => s.costs.total), 
                    backgroundColor: '#60a5fa',
                    borderColor: '#3b82f6',
                    borderWidth: 1
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    } 
                } 
            }
        });
        
        // Create cost breakdown chart
        window.breakdownChart = new Chart(breakdownChart.getContext('2d'), {
            type: 'doughnut',
            data: { 
                labels: ['Labor', 'Equipment', 'Product', 'Contractor'], 
                datasets: [{ 
                    data: Object.values(costBreakdown), 
                    backgroundColor: ['#f87171', '#fb923c', '#fbbf24', '#a3e635'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // --- ROUTING ---
    const routes = {
        '#dashboard': { template: dashboardTemplate, title: 'Dashboard', init: renderDashboardCharts },
        '#storm-list': { template: stormListTemplate, title: 'Data List', init: initStormListListeners },
    };
    
    function router() {
        const path = window.location.hash || '#dashboard';
        const route = routes[path];
        if (route) {
            app.innerHTML = route.template();
            pageTitle.textContent = route.title;
            updateActiveLink(path);
            if (route.init) {
                // Add small delay to ensure DOM is ready
                setTimeout(route.init, 100);
            }
        } else {
            window.location.hash = '#dashboard';
        }
    }
    
    function updateActiveLink(path) {
        navLinks.forEach(link => {
            link.classList.toggle('bg-blue-500', link.getAttribute('href') === path);
            link.classList.toggle('text-white', link.getAttribute('href') === path);
        });
    }

    // --- MODAL & FORM LOGIC ---
    function openModal(modalElement) { 
        modalElement.style.display = 'block'; 
        modalBackdrop.style.display = 'block'; 
        document.body.style.overflow = 'hidden';
    }
    
    function closeModal(modalElement) { 
        modalElement.style.display = 'none'; 
        if (!document.querySelector('.modal[style*="display: block"]')) {
            modalBackdrop.style.display = 'none'; 
            document.body.style.overflow = 'auto';
        }
    }

    function showStormInModal(storm) {
        activeStormId = storm.id;
        document.getElementById('storm-id').value = storm.id;
        
        // Set info tab to active and render all panes
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.modal-tab[data-tab="info"]').classList.add('active');
        document.querySelectorAll('.modal-content-pane').forEach(p => p.classList.remove('active'));
        document.getElementById('pane-info').classList.add('active');

        Object.keys(paneTemplates).forEach(paneId => renderDynamicPane(paneId, storm[paneId]));
        Object.keys(storm.info).forEach(key => {
            const el = document.getElementById(`info-${key}`);
            if (el) el.value = storm.info[key];
        });
        openModal(modal);
    }
    
    function collectPaneData(paneId) {
        const pane = document.getElementById(`pane-${paneId}`);
        return Array.from(pane.querySelectorAll('.dynamic-row')).map(row => {
            const item = {};
            row.querySelectorAll('input, select').forEach(input => {
                const key = Array.from(input.classList).find(c => c.startsWith('data-'));
                if (key) {
                    const fieldName = key.split('-')[1];
                    item[fieldName] = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                }
            });
            return item;
        });
    }

    function showStormDetails(stormId) {
        const storm = storms.find(s => s.id == stormId);
        if (!storm) return;

        const createTable = (headers, data, mapping, totals) => {
            let body = data.map(row => `<tr>${mapping.map(key => `<td class="p-2">${row[key] || ''}</td>`).join('')}</tr>`).join('');
            if (totals) {
                body += `<tr class="font-bold border-t-2">${Object.entries(totals).map(([key, value]) => `<td class="p-2">${key}: ${value}</td>`).join('')}</tr>`;
            }
            return `<table class="w-full text-left border-collapse mt-2"><thead><tr class="bg-gray-100">${headers.map(h => `<th class="p-2">${h}</th>`).join('')}</tr></thead><tbody>${body}</tbody></table>`;
        };
        
        const detailsHtml = `
            <h1 class="text-2xl font-bold text-center mb-4">${storm.info.stormName} - Storm Report</h1>
            <div class="grid grid-cols-3 gap-x-4 gap-y-2 text-sm mb-4 border-b pb-4">
                ${Object.entries(storm.info).map(([key, value]) => `<div><strong>${key.replace(/([A-Z])/g, ' $1').trim()}:</strong> ${value}</div>`).join('')}
            </div>
            <h2 class="text-xl font-bold mt-4">Cost Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm mb-4 border-b pb-4">
                ${Object.entries(storm.costs).map(([key, value]) => `<div class="bg-gray-100 p-2 rounded-md"><strong>${key.replace(/([A-Z])/g, ' $1').trim()}:</strong><br>$${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>`).join('')}
            </div>
            <h3 class="text-lg font-bold mt-4">Labor Details</h3>
            ${createTable(['Name', 'Reg Hrs', 'Reg Rate', 'OT Hrs', 'OT Rate'], storm.labor, ['name', 'regHrs', 'regRate', 'otHrs', 'otRate'])}
            <h3 class="text-lg font-bold mt-4">Equipment Details</h3>
            ${createTable(['Name', 'Hours', 'Rate'], storm.equipment, ['name', 'hours', 'rate'])}
            <h3 class="text-lg font-bold mt-4">Product Details</h3>
            ${createTable(['Name', 'Tons Used', '$ per Ton'], storm.product, ['name', 'tons', 'rate'])}
            <h3 class="text-lg font-bold mt-4">Contractor Details</h3>
            ${createTable(['Service', 'Cost'], storm.contractor, ['name', 'cost'])}
        `;
        
        document.getElementById('print-area').innerHTML = detailsHtml;
        document.getElementById('details-modal-title').textContent = `Details for ${storm.info.stormName}`;
        openModal(detailsModal);
    }

    // --- EVENT LISTENERS ---
    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);
    
    document.getElementById('menu-button').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('-translate-x-full');
    });
    
    document.getElementById('add-storm-btn-header').addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'Log New Storm Event';
        showStormInModal({ id: null, info: {}, labor: [], equipment: [], product: [], contractor: [] });
    });
    
    // Modal Listeners
    document.getElementById('close-modal-btn').addEventListener('click', () => closeModal(modal));
    document.getElementById('cancel-btn').addEventListener('click', () => closeModal(modal));
    document.getElementById('close-details-modal-btn').addEventListener('click', () => closeModal(detailsModal));
    document.getElementById('print-details-btn').addEventListener('click', () => window.print());
    modalBackdrop.addEventListener('click', () => { closeModal(modal); closeModal(detailsModal); });
    
    document.getElementById('modal-tabs').addEventListener('click', (e) => {
        const tabButton = e.target.closest('.modal-tab');
        if (tabButton) {
            const tabId = tabButton.dataset.tab;
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.modal-content-pane').forEach(p => p.classList.remove('active'));
            tabButton.classList.add('active');
            document.getElementById(`pane-${tabId}`).classList.add('active');
        }
    });

    modal.addEventListener('click', (e) => {
        const addBtn = e.target.closest('.add-row-btn');
        const deleteBtn = e.target.closest('.delete-row-btn');
        const suggestBtn = e.target.closest('#suggest-name-btn');

        if (addBtn) {
            e.preventDefault();
            addBtn.insertAdjacentHTML('beforebegin', paneTemplates[addBtn.dataset.pane]());
        }
        if (deleteBtn) {
            e.preventDefault();
            deleteBtn.closest('.dynamic-row').remove();
        }
        if (suggestBtn) {
            e.preventDefault();
            suggestBtn.disabled = true;
            callGemini("Suggest a single, creative name for a winter snow storm. Only return the name, nothing else.").then(name => {
                document.getElementById('info-stormName').value = name;
                suggestBtn.disabled = false;
            });
        }
    });
    
    stormForm.addEventListener('submit', (e) => {
        e.preventDefault();
        document.getElementById('save-spinner').style.display = 'block';

        const storm = {
            id: activeStormId || Date.now(),
            info: {},
            labor: collectPaneData('labor'),
            equipment: collectPaneData('equipment'),
            product: collectPaneData('product'),
            contractor: collectPaneData('contractor'),
            costs: { labor: 0, equipment: 0, product: 0, contractor: 0, total: 0 }
        };

        stormForm.querySelectorAll('#pane-info [id^="info-"]').forEach(el => {
            const key = el.id.split('-')[1];
            storm.info[key] = el.type.match(/number|range/) ? parseFloat(el.value) || 0 : el.value;
        });

        storm.costs.labor = storm.labor.reduce((acc, item) => acc + (item.regHrs * item.regRate) + (item.otHrs * item.otRate), 0);
        storm.costs.equipment = storm.equipment.reduce((acc, item) => acc + (item.hours * item.rate), 0);
        storm.costs.product = storm.product.reduce((acc, item) => acc + (item.tons * item.rate), 0);
        storm.costs.contractor = storm.contractor.reduce((acc, item) => acc + item.cost, 0);
        storm.costs.total = storm.costs.labor + storm.costs.equipment + storm.costs.product + storm.costs.contractor;

        const existingIndex = storms.findIndex(s => s.id === storm.id);
        if (existingIndex > -1) {
            storms[existingIndex] = storm;
        } else {
            storms.push(storm);
        }
        
        document.getElementById('save-spinner').style.display = 'none';
        closeModal(modal);
        router();
    });

    function initStormListListeners() {
        app.addEventListener('click', (e) => {
            const detailsBtn = e.target.closest('.details-btn');
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (detailsBtn) showStormDetails(detailsBtn.dataset.id);
            if (editBtn) {
                const storm = storms.find(s => s.id == editBtn.dataset.id);
                document.getElementById('modal-title').textContent = `Edit ${storm.info.stormName}`;
                showStormInModal(storm);
            }
            if (deleteBtn) {
                if (confirm('Are you sure you want to delete this storm?')) {
                    storms = storms.filter(s => s.id != deleteBtn.dataset.id);
                    router();
                }
            }
        });
    }

    // Initial load
    router();
});
</script>
</body>
</html> 